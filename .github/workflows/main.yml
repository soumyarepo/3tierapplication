name: CI/CD Pipeline - 3 Tier Banking App

on:
  push:
    branches: [testing-job]
  pull_request:
    branches: [testing-job]

env:
  AWS_REGION: ap-south-1
  ECR_REPO: 3tierbanking-app
  BACKEND_IMAGE: backend
  FRONTEND_IMAGE: frontend
  RELEASE_NAME: banking-app

##############################################################
# 1) BUILD STAGE
##############################################################
jobs:
  build:
    name: Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4

      - name: Print Branch Info
        run: |
          echo "===================================="
          echo "Branch: $GITHUB_REF"
          echo "Commit: $GITHUB_SHA"
          echo "===================================="

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install Backend Dependencies
        working-directory: backend
        run: |
          echo "Installing backend dependencies..."
          npm install
          echo "Backend dependencies installed"

      - name: Install Frontend Dependencies
        working-directory: frontend
        run: |
          echo "Installing frontend dependencies..."
          npm install
          echo "Frontend dependencies installed"

      - name: Build Frontend
        working-directory: frontend
        run: |
          echo "Building frontend..."
          npm run build
          echo "Frontend build successful"

##############################################################
# 2) UNIT TEST STAGE (Jest with coverage & thresholds)
##############################################################
  unit-test:
    name: Unit Test (Jest)
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install Backend Dependencies for Tests
        working-directory: backend
        run: |
          echo "Installing backend dependencies for tests..."
          npm install
          echo "Dependencies installed"

      - name: Run Jest Tests with Coverage & Threshold
        working-directory: backend
        run: |
          echo "===================================="
          echo "Running Jest unit tests with coverage and enforcing thresholds..."
          npx jest --runInBand --coverage \
            --coverageReporters=text-summary \
            --coverageReporters=json \
            --coverageReporters=lcov \
            --coverageThreshold='{"global": {"branches": 40, "functions": 15, "lines": 40, "statements": 40}}'
          echo "Jest tests completed"
          echo "Coverage reports generated in ./coverage"
          echo "===================================="

      - name: Upload Coverage JSON
        uses: actions/upload-artifact@v4
        with:
          name: jest-coverage-json
          path: backend/coverage/coverage-summary.json

      - name: Upload Full Coverage Folder
        uses: actions/upload-artifact@v4
        with:
          name: jest-coverage-full
          path: backend/coverage/

##############################################################
# 3) SONARQUBE SCAN STAGE
##############################################################
  sonarqube-scan:
    name: SonarQube Scan
    runs-on: ubuntu-latest
    needs: unit-test

    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0


      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install Sonar Scanner
        run: |
          npm install -g sonar-scanner@latest

      - name: Run SonarQube Analysis
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          echo "Running SonarQube analysis..."
          sonar-scanner \
            -Dsonar.projectKey=soumyarepo_3tierapplication \
            -Dsonar.organization=soumyarepo \
            -Dsonar.sources=. \
            -Dsonar.host.url=https://sonarcloud.io \
            -Dsonar.login=$SONAR_TOKEN \
            -Dsonar.javascript.lcov.reportPaths=backend/coverage/lcov-report/lcov.info \
            -Dsonar.coverage.exclusions=**/node_modules/**,**/__tests__/** \
            -Dsonar.branch.name=master
          echo "SonarQube analysis completed"
      - name: Fetch SonarQube Metrics (Bugs & Vulnerabilities)
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          echo "===================================="
          echo "Fetching SonarQube metrics..."
          echo "===================================="

          curl -s -u $SONAR_TOKEN: \
            "https://sonarcloud.io/api/measures/component?component=soumyarepo_3tierapplication&metricKeys=bugs,vulnerabilities,code_smells,security_hotspots,coverage,duplicated_lines_density" \
            > sonar-metrics.json

          echo "Raw Sonar metrics JSON:"
          cat sonar-metrics.json

      - name: Display Human Readable Sonar Report
        run: |
          BUGS=$(jq -r '.component.measures[] | select(.metric=="bugs") | .value' sonar-metrics.json)
          VULNS=$(jq -r '.component.measures[] | select(.metric=="vulnerabilities") | .value' sonar-metrics.json)
          SMELLS=$(jq -r '.component.measures[] | select(.metric=="code_smells") | .value' sonar-metrics.json)
          HOTSPOTS=$(jq -r '.component.measures[] | select(.metric=="security_hotspots") | .value' sonar-metrics.json)
          COVERAGE=$(jq -r '.component.measures[] | select(.metric=="coverage") | .value')
          DUPLICATION=$(jq -r '.component.measures[] | select(.metric=="duplicated_lines_density") | .value')

          echo "===================================="
          echo " SonarQube Analysis Report"
          echo "===================================="
          printf "%-25s %s\n" "Bugs:" "${BUGS:-0}"
          printf "%-25s %s\n" "Vulnerabilities:" "${VULNS:-0}"
          printf "%-25s %s\n" "Code Smells:" "${SMELLS:-0}"
          printf "%-25s %s\n" "Security Hotspots:" "${HOTSPOTS:-0}"
          printf "%-25s %s%%\n" "Coverage:" "${COVERAGE:-0}"
          printf "%-25s %s%%\n" "Duplications:" "${DUPLICATION:-0}"
          echo "===================================="

      - name: Publish Sonar Report to GitHub Summary
        run: |
          BUGS=$(jq -r '.component.measures[] | select(.metric=="bugs") | .value' sonar-metrics.json)
          VULNS=$(jq -r '.component.measures[] | select(.metric=="vulnerabilities") | .value' sonar-metrics.json)
          SMELLS=$(jq -r '.component.measures[] | select(.metric=="code_smells") | .value' sonar-metrics.json)
          HOTSPOTS=$(jq -r '.component.measures[] | select(.metric=="security_hotspots") | .value' sonar-metrics.json)
          COVERAGE=$(jq -r '.component.measures[] | select(.metric=="coverage") | .value')
          DUPLICATION=$(jq -r '.component.measures[] | select(.metric=="duplicated_lines_density") | .value')

          cat <<EOF >> $GITHUB_STEP_SUMMARY
          ## ðŸ” SonarQube Code Quality Report

          | Metric | Count |
          |-------|-------|
          | ðŸž Bugs | ${BUGS:-0} |
          | ðŸ” Vulnerabilities | ${VULNS:-0} |
          | ðŸ§¹ Code Smells | ${SMELLS:-0} |
          | ðŸ”¥ Security Hotspots | ${HOTSPOTS:-0} |
          | ðŸ“Š Coverage | ${COVERAGE:-0}% |
          | ðŸ§¬ Duplication | ${DUPLICATION:-0}% |

          EOF
      - name: Fetch Sonar Issues (Severity-wise Table)
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          PROJECT_KEY="soumyarepo_3tierapplication"

          echo "## ðŸ” SonarCloud Issues Report (Severity-wise)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Severity | Type | File | Line | Message |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|------|------|------|---------|" >> $GITHUB_STEP_SUMMARY

          curl -s -u "$SONAR_TOKEN:" \
            "https://sonarcloud.io/api/issues/search?componentKeys=$PROJECT_KEY&resolved=false&ps=500" \
            -o sonar-issues.json

          for SEV in BLOCKER CRITICAL MAJOR MINOR INFO; do
            jq -r --arg sev "$SEV" '
              .issues[]
              | select(.severity==$sev)
              | "| \(.severity) | \(.type) | \(.component | split(":")[1]) | \(.line // "-") | \(.message | gsub("\n"; " ") | gsub("\\|"; "/")) |"
            ' sonar-issues.json >> $GITHUB_STEP_SUMMARY
          done


##############################################################
# 4) DOCKER BUILD STAGE
##############################################################
  docker-build:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: sonarqube-scan

    outputs:
      ecr_registry: ${{ steps.ecr.outputs.registry }}

    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Verify AWS Identity
        run: |
          echo "Verifying AWS identity..."
          aws sts get-caller-identity

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set ECR Registry
        id: ecr
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          REGISTRY="$ACCOUNT_ID.dkr.ecr.${AWS_REGION}.amazonaws.com"
          echo "ECR Registry: $REGISTRY"
          echo "registry=$REGISTRY" >> $GITHUB_OUTPUT

      - name: Build Backend Docker Image
        run: |
          echo "Building backend Docker image..."
          docker build -t backend:latest ./backend
          docker images | grep backend

      - name: Build Frontend Docker Image
        run: |
          echo "Building frontend Docker image..."
          docker build -t frontend:latest ./frontend
          docker images | grep frontend

##############################################################
# 5) DOCKER PUSH STAGE
##############################################################
  docker-push:
    name: Docker Push
    runs-on: ubuntu-latest
    needs: docker-build

    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Push Backend Image
        run: |
          ECR=${{ needs.docker-build.outputs.ecr_registry }}
          echo "Pushing backend image..."
          docker tag backend:latest $ECR/${{ env.ECR_REPO }}:${{ env.BACKEND_IMAGE }}
          docker push $ECR/${{ env.ECR_REPO }}:${{ env.BACKEND_IMAGE }}

      - name: Push Frontend Image
        run: |
          ECR=${{ needs.docker-build.outputs.ecr_registry }}
          echo "Pushing frontend image..."
          docker tag frontend:latest $ECR/${{ env.ECR_REPO }}:${{ env.FRONTEND_IMAGE }}
          docker push $ECR/${{ env.ECR_REPO }}:${{ env.FRONTEND_IMAGE }}