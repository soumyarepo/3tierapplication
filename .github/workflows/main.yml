name: CI/CD Pipeline - 3 Tier Banking App

on:
  push:
    branches: [testing-job]
  pull_request:
    branches: [testing-job]

env:
  AWS_REGION: ap-south-1
  ECR_REPO: 3tierbanking-app
  BACKEND_IMAGE: backend
  FRONTEND_IMAGE: frontend
  RELEASE_NAME: banking-app

jobs:

##############################################################
# 1) BUILD STAGE
##############################################################
  build:
    name: Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4

      - name: Print Branch Info
        run: |
          echo "Branch: $GITHUB_REF"
          echo "Commit: $GITHUB_SHA"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install Backend Dependencies
        working-directory: backend
        run: npm install

      - name: Install Frontend Dependencies
        working-directory: frontend
        run: npm install

      - name: Build Frontend
        working-directory: frontend
        run: npm run build

##############################################################
# 2) UNIT TEST STAGE
##############################################################
  unit-test:
    name: Unit Test (Jest)
    runs-on: ubuntu-latest
    needs: build

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install Backend Dependencies
        working-directory: backend
        run: npm install

      - name: Run Jest with Coverage
        working-directory: backend
        run: |
          npx jest --runInBand --coverage \
            --coverageReporters=text-summary \
            --coverageReporters=json \
            --coverageReporters=lcov \
            --coverageThreshold='{"global":{"branches":40,"functions":15,"lines":40,"statements":40}}'

      - uses: actions/upload-artifact@v4
        with:
          name: jest-coverage
          path: backend/coverage/

##############################################################
# 3) SONARQUBE SCAN STAGE
##############################################################
  sonarqube-scan:
    name: SonarQube Scan
    runs-on: ubuntu-latest
    needs: unit-test

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install Sonar Scanner
        run: npm install -g sonar-scanner@latest

      - name: Run SonarQube Analysis
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          sonar-scanner \
            -Dsonar.projectKey=soumyarepo_3tierapplication \
            -Dsonar.organization=soumyarepo \
            -Dsonar.sources=. \
            -Dsonar.host.url=https://sonarcloud.io \
            -Dsonar.login=$SONAR_TOKEN \
            -Dsonar.javascript.lcov.reportPaths=backend/coverage/lcov-report/lcov.info \
            -Dsonar.coverage.exclusions=**/node_modules/**,**/__tests__/** \
            -Dsonar.branch.name=master

      - name: Fetch Sonar Metrics
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          curl -s -u "$SONAR_TOKEN:" \
            "https://sonarcloud.io/api/measures/component?component=soumyarepo_3tierapplication&metricKeys=bugs,vulnerabilities,code_smells,security_hotspots,coverage,duplicated_lines_density" \
            > sonar-metrics.json

      - name: Publish Metrics to Summary
        run: |
          BUGS=$(jq -r '.component.measures[]|select(.metric=="bugs")|.value' sonar-metrics.json)
          VULNS=$(jq -r '.component.measures[]|select(.metric=="vulnerabilities")|.value' sonar-metrics.json)
          SMELLS=$(jq -r '.component.measures[]|select(.metric=="code_smells")|.value' sonar-metrics.json)
          HOTSPOTS=$(jq -r '.component.measures[]|select(.metric=="security_hotspots")|.value' sonar-metrics.json)
          COVERAGE=$(jq -r '.component.measures[]|select(.metric=="coverage")|.value')
          DUPLICATION=$(jq -r '.component.measures[]|select(.metric=="duplicated_lines_density")|.value')

          cat <<EOF >> $GITHUB_STEP_SUMMARY
          ## ðŸ” SonarQube Code Quality Report

          | Metric | Value |
          |-------|-------|
          | ðŸž Bugs | ${BUGS:-0} |
          | ðŸ” Vulnerabilities | ${VULNS:-0} |
          | ðŸ§¹ Code Smells | ${SMELLS:-0} |
          | ðŸ”¥ Security Hotspots | ${HOTSPOTS:-0} |
          | ðŸ“Š Coverage | ${COVERAGE:-0}% |
          | ðŸ§¬ Duplication | ${DUPLICATION:-0}% |
          EOF

      - name: Sonar Issues Summary & Table
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          PROJECT_KEY="soumyarepo_3tierapplication"

          curl -s -u "$SONAR_TOKEN:" \
            "https://sonarcloud.io/api/issues/search?componentKeys=$PROJECT_KEY&resolved=false&ps=500" \
            -o sonar-issues.json

          BLOCKER=$(jq '[.issues[]|select(.severity=="BLOCKER")]|length' sonar-issues.json)
          CRITICAL=$(jq '[.issues[]|select(.severity=="CRITICAL")]|length' sonar-issues.json)
          MAJOR=$(jq '[.issues[]|select(.severity=="MAJOR")]|length' sonar-issues.json)
          MINOR=$(jq '[.issues[]|select(.severity=="MINOR")]|length' sonar-issues.json)
          INFO=$(jq '[.issues[]|select(.severity=="INFO")]|length' sonar-issues.json)

          echo "## ðŸš¦ SonarCloud Issues Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸš¨ BLOCKER | $BLOCKER |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”¥ CRITICAL | $CRITICAL |" >> $GITHUB_STEP_SUMMARY
          echo "| âš ï¸ MAJOR | $MAJOR |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŸ¡ MINOR | $MINOR |" >> $GITHUB_STEP_SUMMARY
          echo "| â„¹ï¸ INFO | $INFO |" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“‹ Detailed Issues" >> $GITHUB_STEP_SUMMARY
          echo "| Severity | Type | File | Line | Message |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|------|------|------|---------|" >> $GITHUB_STEP_SUMMARY

          for SEV in BLOCKER CRITICAL MAJOR MINOR INFO; do
            jq -r --arg sev "$SEV" '
              .issues[] | select(.severity==$sev)
              | "| \(.severity) | \(.type) | \(.component|split(":")[1]) | \(.line//"-") | \(.message|gsub("\n";" ")|gsub("\\|";"/")) |"
            ' sonar-issues.json >> $GITHUB_STEP_SUMMARY
          done

          # âŒ FUTURE USE: Fail pipeline if BLOCKER / CRITICAL > 0
          # if [ "$BLOCKER" -gt 0 ] || [ "$CRITICAL" -gt 0 ]; then
          #   exit 1
          # fi

##############################################################
# 3.1) SONARQUBE QUALITY GATE STAGE
##############################################################
  sonar-quality-gate:
    name: Sonar Quality Gate
    runs-on: ubuntu-latest
    needs: sonarqube-scan

    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check SonarCloud Quality Gate via API
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          echo "===================================="
          echo "Checking SonarCloud Quality Gate status..."
          echo "===================================="

          # Fetch Quality Gate JSON
          QG_JSON=$(curl -s -u "$SONAR_TOKEN:" \
            "https://sonarcloud.io/api/qualitygates/project_status?projectKey=soumyarepo_3tierapplication")

          # Print raw JSON to console
          echo "$QG_JSON" | jq

          # Extract overall status
          STATUS=$(echo "$QG_JSON" | jq -r '.projectStatus.status')
          echo "SonarCloud Quality Gate Status: $STATUS"

          # Extract metric conditions for summary table
          echo "## ðŸ” SonarCloud Quality Gate Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Status | Threshold | Actual |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|----------|--------|" >> $GITHUB_STEP_SUMMARY

          echo "$QG_JSON" | jq -r '
            .projectStatus.conditions[] |
            "| \(.metricKey) | \(.status) | \(.errorThreshold // "-") | \(.actualValue // "-") |"
          ' >> $GITHUB_STEP_SUMMARY

          echo "===================================="
          echo "Quality Gate check completed"
          echo "===================================="

          # ----------------------------------------------------
          # âŒ FUTURE USE: Fail pipeline if Quality Gate is not OK
          # ----------------------------------------------------
          # if [ "$STATUS" != "OK" ]; then
          #   echo "âŒ Build failed due to SonarCloud Quality Gate failure"
          #   exit 1
          # fi

##############################################################
# 4) DOCKER BUILD STAGE
##############################################################
  docker-build:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: sonar-quality-gate

    steps:
      - uses: actions/checkout@v4

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - uses: aws-actions/amazon-ecr-login@v2

      - name: Build Docker Images
        run: |
          docker build -t backend:latest ./backend
          docker build -t frontend:latest ./frontend

##############################################################
# 5) TRIVY SCAN STAGE
##############################################################
  trivy-scan:
    name: Trivy Container Scan
    runs-on: ubuntu-latest
    needs: docker-build

    steps:
      - uses: actions/checkout@v4

      - name: Install Trivy
        run: |
          sudo apt-get update
          sudo apt-get install -y wget
          wget https://github.com/aquasecurity/trivy/releases/latest/download/trivy_0.44.0_Linux-64bit.deb
          sudo dpkg -i trivy_0.44.0_Linux-64bit.deb

      - name: Scan Backend Image
        env:
          AWS_REGION: ${{ env.AWS_REGION }}
          ECR_REPO: ${{ env.ECR_REPO }}
          BACKEND_IMAGE: ${{ env.BACKEND_IMAGE }}
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          ECR="$ACCOUNT_ID.dkr.ecr.${AWS_REGION}.amazonaws.com"

          echo "## ðŸ” Scanning Backend Image: $ECR/${ECR_REPO}:${BACKEND_IMAGE}" >> $GITHUB_STEP_SUMMARY

          trivy image -f json -o trivy-backend.json $ECR/${ECR_REPO}:${BACKEND_IMAGE}

          echo "| Vulnerability | Severity | Package | Installed Version | Fixed Version |" >> $GITHUB_STEP_SUMMARY
          echo "|---------------|---------|--------|-----------------|--------------|" >> $GITHUB_STEP_SUMMARY

          jq -r '.Results[].Vulnerabilities[]? | "| \(.VulnerabilityID) | \(.Severity) | \(.PkgName) | \(.InstalledVersion) | \(.FixedVersion // "-") |"' trivy-backend.json >> $GITHUB_STEP_SUMMARY

      - name: Scan Frontend Image
        env:
          AWS_REGION: ${{ env.AWS_REGION }}
          ECR_REPO: ${{ env.ECR_REPO }}
          FRONTEND_IMAGE: ${{ env.FRONTEND_IMAGE }}
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          ECR="$ACCOUNT_ID.dkr.ecr.${AWS_REGION}.amazonaws.com"

          echo "## ðŸ” Scanning Frontend Image: $ECR/${ECR_REPO}:${FRONTEND_IMAGE}" >> $GITHUB_STEP_SUMMARY

          trivy image -f json -o trivy-frontend.json $ECR/${ECR_REPO}:${FRONTEND_IMAGE}

          echo "| Vulnerability | Severity | Package | Installed Version | Fixed Version |" >> $GITHUB_STEP_SUMMARY
          echo "|---------------|---------|--------|-----------------|--------------|" >> $GITHUB_STEP_SUMMARY

          jq -r '.Results[].Vulnerabilities[]? | "| \(.VulnerabilityID) | \(.Severity) | \(.PkgName) | \(.InstalledVersion) | \(.FixedVersion // "-") |"' trivy-frontend.json >> $GITHUB_STEP_SUMMARY


##############################################################
# 6) DOCKER PUSH STAGE
##############################################################
  docker-push:
    name: Docker Push
    runs-on: ubuntu-latest
    needs: trivy-scan

    steps:
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - uses: aws-actions/amazon-ecr-login@v2

      - name: Push Images
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          ECR="$ACCOUNT_ID.dkr.ecr.${AWS_REGION}.amazonaws.com"

          docker tag backend:latest $ECR/${ECR_REPO}:${BACKEND_IMAGE}
          docker tag frontend:latest $ECR/${ECR_REPO}:${FRONTEND_IMAGE}

          docker push $ECR/${ECR_REPO}:${BACKEND_IMAGE}
          docker push $ECR/${ECR_REPO}:${FRONTEND_IMAGE}