name: CI/CD Pipeline - 3 Tier Banking App

on:
  push:
    branches: [testing-job]
  pull_request:
    branches: [testing-job]

env:
  AWS_REGION: ap-south-1
  ECR_REPO: 3tierbanking-app
  BACKEND_IMAGE: backend
  FRONTEND_IMAGE: frontend
  RELEASE_NAME: banking-app

##############################################################
# 1) BUILD STAGE
##############################################################
jobs:
  build:
    name: Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4

      - name: Print Branch Info
        run: |
          echo "===================================="
          echo "Branch: $GITHUB_REF"
          echo "Commit: $GITHUB_SHA"
          echo "===================================="

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install Backend Dependencies
        working-directory: backend
        run: |
          echo "Installing backend dependencies..."
          npm install
          echo "Backend dependencies installed"

      - name: Install Frontend Dependencies
        working-directory: frontend
        run: |
          echo "Installing frontend dependencies..."
          npm install
          echo "Frontend dependencies installed"

      - name: Build Frontend
        working-directory: frontend
        run: |
          echo "Building frontend..."
          npm run build
          echo "Frontend build successful"

##############################################################
# 2) UNIT TEST STAGE (JEST with coverage + threshold)
##############################################################
  unit-test:
    name: Unit Test (Jest)
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install Backend Dependencies
        working-directory: backend
        run: |
          echo "Installing backend dependencies for tests..."
          npm install
          echo "Dependencies installed"

      - name: Run Jest Tests with Coverage and Threshold
        working-directory: backend
        run: |
          echo "===================================="
          echo "Running Jest unit tests with coverage and enforcing thresholds..."
          npx jest --runInBand --coverage \
            --coverageReporters=text-summary \
            --coverageReporters=json \
            --coverageReporters=lcov \
            --coverageThreshold='{"global": {"branches": 50, "functions": 50, "lines": 50, "statements": 50}}'
          echo "Jest tests passed successfully"
          echo "Coverage reports generated in ./coverage"
          echo "===================================="

      - name: Upload Coverage JSON
        uses: actions/upload-artifact@v4
        with:
          name: jest-coverage-json
          path: backend/coverage/coverage-summary.json

      - name: Upload Full Coverage Folder
        uses: actions/upload-artifact@v4
        with:
          name: jest-coverage-full
          path: backend/coverage/

##############################################################
# 3) DOCKER BUILD STAGE
##############################################################
  docker-build:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: unit-test

    outputs:
      ecr_registry: ${{ steps.ecr.outputs.registry }}

    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Verify AWS Identity
        run: |
          echo "Verifying AWS identity..."
          aws sts get-caller-identity

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set ECR Registry
        id: ecr
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          REGISTRY="$ACCOUNT_ID.dkr.ecr.${AWS_REGION}.amazonaws.com"
          echo "ECR Registry: $REGISTRY"
          echo "registry=$REGISTRY" >> $GITHUB_OUTPUT

      - name: Build Backend Docker Image
        run: |
          echo "Building backend Docker image..."
          docker build -t backend:latest ./backend
          docker images | grep backend

      - name: Build Frontend Docker Image
        run: |
          echo "Building frontend Docker image..."
          docker build -t frontend:latest ./frontend
          docker images | grep frontend

##############################################################
# 4) DOCKER PUSH STAGE
##############################################################
  docker-push:
    name: Docker Push
    runs-on: ubuntu-latest
    needs: docker-build

    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Push Backend Image
        run: |
          ECR=${{ needs.docker-build.outputs.ecr_registry }}
          echo "Pushing backend image..."
          docker tag backend:latest $ECR/${{ env.ECR_REPO }}:${{ env.BACKEND_IMAGE }}
          docker push $ECR/${{ env.ECR_REPO }}:${{ env.BACKEND_IMAGE }}

      - name: Push Frontend Image
        run: |
          ECR=${{ needs.docker-build.outputs.ecr_registry }}
          echo "Pushing frontend image..."
          docker tag frontend:latest $ECR/${{ env.ECR_REPO }}:${{ env.FRONTEND_IMAGE }}
          docker push $ECR/${{ env.ECR_REPO }}:${{ env.FRONTEND_IMAGE }}