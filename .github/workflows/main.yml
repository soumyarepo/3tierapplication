name: CI/CD Pipeline - 3 Tier Banking App

on:
  push:
    branches: [testing-job]
  pull_request:
    branches: [testing-job]

env:
  AWS_REGION: ap-south-1
  ECR_REPO: 3tierbanking-app
  BACKEND_IMAGE: backend
  FRONTEND_IMAGE: frontend
  RELEASE_NAME: banking-app

##############################################################
# 1) BUILD & TEST STAGE
##############################################################
jobs:
  build-test:
    name: Build & Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4

      - name: Print Branch Info
        run: |
          echo "===================================="
          echo "Running on branch: $GITHUB_REF"
          echo "Commit SHA: $GITHUB_SHA"
          echo "===================================="

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install Backend Dependencies
        working-directory: backend
        run: |
          echo "Installing backend dependencies..."
          npm install
          echo "Backend dependencies installed successfully"

      - name: Install Frontend Dependencies
        working-directory: frontend
        run: |
          echo "Installing frontend dependencies..."
          npm install
          echo "Frontend dependencies installed successfully"

      - name: Build Frontend
        working-directory: frontend
        run: |
          echo "Building frontend application..."
          npm run build
          echo "Frontend build completed"

##############################################################
# 2) DOCKER BUILD STAGE
##############################################################
  docker-build:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: build-test

    outputs:
      ecr_registry: ${{ steps.ecr.outputs.registry }}

    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Verify AWS Identity
        run: |
          echo "Verifying AWS identity..."
          aws sts get-caller-identity

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set ECR Registry
        id: ecr
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          REGISTRY="$ACCOUNT_ID.dkr.ecr.${AWS_REGION}.amazonaws.com"
          echo "ECR Registry: $REGISTRY"
          echo "registry=$REGISTRY" >> $GITHUB_OUTPUT

      - name: Build Backend Docker Image
        run: |
          echo "===================================="
          echo "Building Backend Docker image..."
          docker build -t backend:latest ./backend
          docker images | grep backend
          echo "Backend Docker image build completed"
          echo "===================================="

      - name: Build Frontend Docker Image
        run: |
          echo "===================================="
          echo "Building Frontend Docker image..."
          docker build -t frontend:latest ./frontend
          docker images | grep frontend
          echo "Frontend Docker image build completed"
          echo "===================================="

##############################################################
# 3) DOCKER PUSH STAGE
##############################################################
  docker-push:
    name: Docker Push
    runs-on: ubuntu-latest
    needs: docker-build

    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Tag & Push Backend Image
        run: |
          echo "===================================="
          ECR=${{ needs.docker-build.outputs.ecr_registry }}
          echo "ECR Registry: $ECR"
          echo "Tagging backend image..."
          docker tag backend:latest $ECR/${{ env.ECR_REPO }}:${{ env.BACKEND_IMAGE }}
          echo "Pushing backend image to ECR..."
          docker push $ECR/${{ env.ECR_REPO }}:${{ env.BACKEND_IMAGE }}
          echo "Backend image pushed successfully"
          echo "===================================="

      - name: Tag & Push Frontend Image
        run: |
          echo "===================================="
          ECR=${{ needs.docker-build.outputs.ecr_registry }}
          echo "ECR Registry: $ECR"
          echo "Tagging frontend image..."
          docker tag frontend:latest $ECR/${{ env.ECR_REPO }}:${{ env.FRONTEND_IMAGE }}
          echo "Pushing frontend image to ECR..."
          docker push $ECR/${{ env.ECR_REPO }}:${{ env.FRONTEND_IMAGE }}
          echo "Frontend image pushed successfully"
          echo "===================================="
